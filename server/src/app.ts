import express from 'express';
import cors from 'cors';
import { initializeApp, cert } from 'firebase-admin/app';
import { getAuth } from 'firebase-admin/auth';
import Database from 'better-sqlite3';
import dotenv from 'dotenv';

// RequestÂûã„ÅÆÊã°Âºµ
declare global {
  namespace Express {
    interface Request {
      user?: any;
    }
  }
}

dotenv.config();

const app = express();
const port = process.env.PORT || 3001;

// Firebase Admin SDK„ÅÆÂàùÊúüÂåñ
initializeApp({
  credential: cert({
    projectId: process.env.FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
  })
});

const allowedOrigins = [
  'http://localhost:5173',
  'https://fitty2501.xyz'
];

app.use(cors({
  origin: (origin, callback) => {
    // origin„Ååundefined„Å™Â†¥ÂêàÔºàPostman„Å™„Å©Ôºâ„ÇÇË®±ÂèØ
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('CORS„Éù„É™„Ç∑„Éº„Å´„Çà„ÇäÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü'));
    }
  },
  methods: ['GET', 'POST', 'PATCH', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}));

// OPTIONS„É™„ÇØ„Ç®„Çπ„ÉàÁî®Ôºà„Éó„É™„Éï„É©„Ç§„ÉàÂØæÂøúÔºâ
app.options('*', cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('CORS„Éù„É™„Ç∑„Éº„Å´„Çà„ÇäÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü'));
    }
  },
  credentials: true
}));

// JSON„Éë„Éº„Çµ„Éº„ÅÆË®≠ÂÆö
app.use(express.json());

// ÂÖ®API„É¨„Çπ„Éù„É≥„Çπ„Å´„Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñ„Éò„ÉÉ„ÉÄ„Éº„Çí‰ªò‰∏é
app.use((req, res, next) => {
  res.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
  res.set('Pragma', 'no-cache');
  res.set('Expires', '0');
  next();
});

app.use((req, res, next) => {
  console.log(`[${req.method}] ${req.path}`);
  next();
});

// Ë™çË®º„Éü„Éâ„É´„Ç¶„Çß„Ç¢
const authenticateToken = async (req: express.Request, res: express.Response, next: express.NextFunction) => {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }

  try {
    const decodedToken = await getAuth().verifyIdToken(token);
    req.user = decodedToken;

    const uid = decodedToken.uid;
    const email = decodedToken.email;

    // ‚úÖ users „ÉÜ„Éº„Éñ„É´„Å´Â≠òÂú®„Åó„Å™„Åë„Çå„Å∞ÁôªÈå≤
    try {
      const checkUser = db.prepare('SELECT COUNT(*) as count FROM users WHERE id = ?').get(uid) as { count: number };
      if (checkUser.count === 0) {
        db.prepare('INSERT INTO users (id, email, auth_provider) VALUES (?, ?, ?)').run(
          uid,
          email,
          decodedToken.firebase?.sign_in_provider || 'email'
        );
        console.log(`üë§ Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤: ${uid}`);

        // ‚öôÔ∏è user_settings „ÉÜ„Éº„Éñ„É´„Å´„ÇÇÂàùÊúü„É¨„Ç≥„Éº„Éâ‰ΩúÊàê
        db.prepare(`
          INSERT INTO user_settings (
            user_id,
            daily_task_limit,
            theme_mode,
            medication_effect_mode_on,
            default_sort_option,
            ai_aggressiveness_level,
            is_medication_taken,
            effect_start_time,
            effect_duration_minutes,
            time_to_max_effect_minutes,
            time_to_fade_minutes,
            ai_suggestion_enabled,
            onboarding_completed,
            show_completed_tasks,
            daily_reminder_enabled,
            show_hurdle,
            show_importance,
            show_deadline_alert
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).run(
          uid,
          5,              // daily_task_limit
          'default',      // theme_mode
          0,              // medication_effect_mode_on
          'created_at_desc', // default_sort_option
          1,              // ai_aggressiveness_level
          1,              // is_medication_taken
          '08:00',        // effect_start_time
          600,            // effect_duration_minutes
          60,             // time_to_max_effect_minutes
          540,            // time_to_fade_minutes
          1,              // ai_suggestion_enabled
          0,              // onboarding_completed
          1,              // show_completed_tasks
          1,              // daily_reminder_enabled
          1,              // show_hurdle
          0,              // show_importance
          0               // show_deadline_alert
        );
        console.log(`‚öôÔ∏è user_settings ÂàùÊúüÂåñÂÆå‰∫Ü: ${uid}`);
      }
    } catch (err) {
      console.error('‚ùå users„ÉÜ„Éº„Éñ„É´ÁôªÈå≤‰∏≠„Å´„Ç®„É©„Éº:', err);
    }

    next();
  } catch (error) {
    return res.status(403).json({ error: 'ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥„Åß„Åô' });
  }
};

// „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÂàùÊúüÂåñ
const db = new Database('task_manager.db', { verbose: console.log });

// „Éá„Éï„Ç©„É´„Éà„Ç´„ÉÜ„Ç¥„É™„Éº„ÅÆÁôªÈå≤
const defaultCategories = [
  { name: '‰ªï‰∫ã', color: '#FF6B6B', is_default: 1 },
  { name: 'ÁßÅÁî®', color: '#4ECDC4', is_default: 1 },
  { name: '„Åù„ÅÆ‰ªñ', color: '#FFD93D', is_default: 1 }
];

try {
  const checkCategories = db.prepare('SELECT COUNT(*) as count FROM categories WHERE is_default = 1').get() as { count: number };
  if (checkCategories.count === 0) {
    const insertCategory = db.prepare('INSERT INTO categories (name, color, is_default) VALUES (?, ?, ?)');
    defaultCategories.forEach(category => {
      insertCategory.run(category.name, category.color, category.is_default);
    });
    console.log('‚úÖ „Éá„Éï„Ç©„É´„Éà„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü');
  }
} catch (err) {
  console.error('‚ùå „Éá„Éï„Ç©„É´„Éà„Ç´„ÉÜ„Ç¥„É™„ÉºÁôªÈå≤‰∏≠„Å´„Ç®„É©„Éº:', err);
}

// „Çø„Çπ„ÇØÈñ¢ÈÄ£„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/tasks', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  
  interface TaskWithCategory {
    id: number;
    user_id: string;
    name: string;
    description: string | null;
    due_date: string | null;
    importance: string | null;
    estimated_duration_minutes: number | null;
    progress: number;
    category_id: number | null;
    status: string;
    is_deleted: number;
    is_today_task: number;
    suggested_by_ai: number;
    priority_score: number;
    child_order: number;
    task_depth: number;
    created_at: string;
    updated_at: string | null;
    completed_at: string | null;
    deleted_at: string | null;
    category_name: string | null;
    category_color: string | null;
    category_is_default: number | null;
  }

  const tasks = db.prepare(`
    SELECT t.*, c.name as category_name, c.color as category_color, c.is_default as category_is_default
    FROM tasks t
    LEFT JOIN categories c ON t.category_id = c.id
    WHERE t.user_id = ? AND t.is_deleted = 0
  `).all(userId) as TaskWithCategory[];

  // „Ç´„ÉÜ„Ç¥„É™„ÉºÊÉÖÂ†±„ÇíÊï¥ÂΩ¢
  const formattedTasks = tasks.map(task => ({
    ...task,
    category: task.category_id ? {
      id: task.category_id,
      name: task.category_name,
      color: task.category_color,
      is_default: task.category_is_default
    } : null
  }));

  res.json(formattedTasks);
});

app.post('/tasks', authenticateToken, (req, res) => {
  try {
    console.log('üì• POST /tasks body:', req.body);
    console.log('üîê req.user:', req.user);

  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  const task = {
    ...req.body,
    user_id: userId,
    status: 'pending',
    progress: 0,
    is_deleted: 0,
    is_today_task: 0,
    suggested_by_ai: 0,
    priority_score: 0.0,
    child_order: 0,
    task_depth: 0,
    importance: req.body.importance || 'medium',
    estimated_duration_minutes: req.body.estimated_duration_minutes || 30,
    hurdle_level: req.body.hurdle_level || 1,
    memo: req.body.memo || null
  };
  
  console.log('üßæ task:', task);

  const stmt = db.prepare(`
    INSERT INTO tasks (
      user_id, name, description, due_date, importance,
      estimated_duration_minutes, progress, category_id,
      status, is_deleted, is_today_task, suggested_by_ai,
      priority_score, child_order, task_depth, hurdle_level, memo
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `);

  const result = stmt.run(
    task.user_id,
    task.name,
    task.description,
    task.due_date,
    task.importance,
    task.estimated_duration_minutes,
    task.progress,
    task.category_id,
    task.status,
    task.is_deleted,
    task.is_today_task,
    task.suggested_by_ai,
    task.priority_score,
    task.child_order,
    task.task_depth,
    task.hurdle_level,
    task.memo
  );

  res.status(201).json({ ...task, id: result.lastInsertRowid });
} catch (err) {
  console.error('‚ùå „Çø„Çπ„ÇØ‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº:', err);
  res.status(500).json({ error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº', details: err });
}
});

app.patch('/tasks/:id', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }

  const taskId = req.params.id;
  const userId = req.user.uid;
  const updates = req.body;

  const stmt = db.prepare(`
    UPDATE tasks SET
      name = COALESCE(?, name),
      description = COALESCE(?, description),
      due_date = COALESCE(?, due_date),
      importance = COALESCE(?, importance),
      estimated_duration_minutes = COALESCE(?, estimated_duration_minutes),
      progress = COALESCE(?, progress),
      category_id = COALESCE(?, category_id),
      status = COALESCE(?, status),
      is_today_task = COALESCE(?, is_today_task),
      completed_at = COALESCE(?, completed_at),
      memo = COALESCE(?, memo),
      hurdle_level = COALESCE(?, hurdle_level),
      updated_at = CURRENT_TIMESTAMP
    WHERE id = ? AND user_id = ? AND is_deleted = 0
  `);

  try {
    const result = stmt.run(
      updates.name,
      updates.description,
      updates.due_date,
      updates.importance,
      updates.estimated_duration_minutes,
      updates.progress,
      updates.category_id,
      updates.status,
      updates.is_today_task,
      updates.completed_at,
      updates.memo,
      updates.hurdle_level,
      taskId,
      userId
    );

    if (result.changes === 0) {
      return res.status(404).json({ error: '„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }

    res.json({ ...updates, id: taskId });
  } catch (error) {
    console.error('„Çø„Çπ„ÇØÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº:', error);
    res.status(500).json({ error: 'Êõ¥Êñ∞‰∏≠„Å´„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü' });
  }
});

app.delete('/tasks/:id', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const taskId = req.params.id;
  const userId = req.user.uid;

  const stmt = db.prepare(`
    UPDATE tasks 
    SET is_deleted = 1, deleted_at = CURRENT_TIMESTAMP 
    WHERE id = ? AND user_id = ?
  `);

  const result = stmt.run(taskId, userId);

  if (result.changes === 0) {
    return res.status(404).json({ error: '„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
  }
  res.status(204).send();
});

app.patch('/tasks/:id/toggle', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const taskId = req.params.id;
  const userId = req.user.uid;
  const { completed } = req.body;

  const stmt = db.prepare(`
    UPDATE tasks SET
      status = ?,
      completed_at = CASE WHEN ? = 'completed' THEN CURRENT_TIMESTAMP ELSE NULL END,
      updated_at = CURRENT_TIMESTAMP
    WHERE id = ? AND user_id = ? AND is_deleted = 0
  `);

  const result = stmt.run(
    completed ? 'completed' : 'pending',
    completed ? 'completed' : 'pending',
    taskId,
    userId
  );

  if (result.changes === 0) {
    return res.status(404).json({ error: '„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
  }
  res.json({ id: taskId, status: completed ? 'completed' : 'pending' });
});

// „Ç´„ÉÜ„Ç¥„É™„Éº‰∏ÄË¶ß„ÅÆÂèñÂæó
app.get('/categories', authenticateToken, (req, res) => {
  try {
    const stmt = db.prepare(`
      SELECT id, name, color, is_default
      FROM categories
      WHERE user_id IS NULL OR user_id = ?
    `);
    
    const categories = stmt.all(req.user?.uid);
    res.json(categories);
  } catch (err) {
    console.error('„Ç´„ÉÜ„Ç¥„É™„ÉºÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº:', err);
    res.status(500).json({ error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº', details: err });
  }
});

// „É¶„Éº„Ç∂„ÉºË®≠ÂÆöÈñ¢ÈÄ£„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/user-settings', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  console.log('üîç user-settingsÂèñÂæó„É™„ÇØ„Ç®„Çπ„Éà:', { userId });

  let settings = db.prepare(`
    SELECT * FROM user_settings WHERE user_id = ?
  `).get(userId);
  console.log('üì¶ ÂèñÂæó„Åó„Åüuser_settings:', settings);

  if (!settings) {
    console.log('‚ö†Ô∏è user_settings„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂàùÊúü„É¨„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åô');
    // ÂàùÊúü„É¨„Ç≥„Éº„Éâ„Çí‰ΩúÊàê
    db.prepare(`
      INSERT INTO user_settings (
        user_id, daily_task_limit, theme_mode, medication_effect_mode_on, default_sort_option,
        ai_aggressiveness_level, is_medication_taken, effect_start_time, effect_duration_minutes,
        time_to_max_effect_minutes, time_to_fade_minutes, ai_suggestion_enabled, onboarding_completed,
        show_completed_tasks, daily_reminder_enabled, show_hurdle, show_importance, show_deadline_alert
      ) VALUES (?, 5, 'default', 0, 'created_at_desc', 1, 1, '08:00', 600, 60, 540, 1, 0, 1, 1, 1, 0, 0)
    `).run(userId);
    settings = db.prepare('SELECT * FROM user_settings WHERE user_id = ?').get(userId);
    console.log('‚úÖ ‰ΩúÊàê„Åó„ÅüÂàùÊúüuser_settings:', settings);
  }

  res.json(settings);
});

// ‚òÖ Êñ∞Ë¶èËøΩÂä†: „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„ÅÆË°®Á§∫È†ÖÁõÆ„Çí„Åæ„Å®„ÇÅ„Å¶Êõ¥Êñ∞
app.patch('/user-settings', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  const { show_hurdle, show_importance, show_deadline_alert } = req.body;

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  const isBool = (v: any) => v === 0 || v === 1 || v === true || v === false;
  if (
    (show_hurdle !== undefined && !isBool(show_hurdle)) ||
    (show_importance !== undefined && !isBool(show_importance)) ||
    (show_deadline_alert !== undefined && !isBool(show_deadline_alert))
  ) {
    return res.status(400).json({ error: 'ÂÄ§„ÅØ0/1„Åæ„Åü„ÅØtrue/false„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ' });
  }

  // SQLÂãïÁöÑÁîüÊàê
  const fields = [];
  const values = [];
  if (show_hurdle !== undefined) {
    fields.push('show_hurdle = ?');
    values.push(show_hurdle ? 1 : 0);
  }
  if (show_importance !== undefined) {
    fields.push('show_importance = ?');
    values.push(show_importance ? 1 : 0);
  }
  if (show_deadline_alert !== undefined) {
    fields.push('show_deadline_alert = ?');
    values.push(show_deadline_alert ? 1 : 0);
  }
  if (fields.length === 0) {
    return res.status(400).json({ error: 'Êõ¥Êñ∞„Åô„ÇãÈ†ÖÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' });
  }

  const sql = `UPDATE user_settings SET ${fields.join(', ')} WHERE user_id = ?`;
  values.push(userId);

  try {
    const stmt = db.prepare(sql);
    stmt.run(...values);
    // Êõ¥Êñ∞Âæå„ÅÆÂÄ§„ÇíËøî„Åô
    const updated = db.prepare('SELECT * FROM user_settings WHERE user_id = ?').get(userId) as any;
    res.json(updated);
  } catch (err) {
    console.error('‚ùå „É¶„Éº„Ç∂„ÉºË®≠ÂÆöÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº:', err);
    res.status(500).json({ error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº' });
  }
});

app.patch('/user-settings/medication-effect-mode', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  const { medication_effect_mode_on } = req.body;

  if (typeof medication_effect_mode_on !== 'number' || ![0, 1].includes(medication_effect_mode_on)) {
    return res.status(400).json({ error: 'ÁÑ°Âäπ„Å™ÂÄ§„Åß„Åô' });
  }

  const stmt = db.prepare(`
    UPDATE user_settings 
    SET medication_effect_mode_on = ?
    WHERE user_id = ?
  `);

  try {
    stmt.run(medication_effect_mode_on, userId);
    res.json({ medication_effect_mode_on });
  } catch (err) {
    console.error('‚ùå Ëñ¨Âäπ„É¢„Éº„ÉâÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº:', err);
    res.status(500).json({ error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº' });
  }
});

// Ëñ¨Âäπ„É¢„Éº„Éâ„ÅÆË®≠ÂÆöÂÄ§„ÇíÊõ¥Êñ∞„Åô„Çã„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.patch('/user-settings/medication-config', authenticateToken, (req, res) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô' });
  }
  const userId = req.user.uid;
  const { effect_start_time, effect_duration_minutes, time_to_max_effect_minutes, time_to_fade_minutes } = req.body;

  const stmt = db.prepare(`
    UPDATE user_settings 
    SET effect_start_time = ?,
        effect_duration_minutes = ?,
        time_to_max_effect_minutes = ?,
        time_to_fade_minutes = ?
    WHERE user_id = ?
  `);

  try {
    stmt.run(
      effect_start_time,
      effect_duration_minutes,
      time_to_max_effect_minutes,
      time_to_fade_minutes,
      userId
    );
    res.json({ effect_start_time, effect_duration_minutes, time_to_max_effect_minutes, time_to_fade_minutes });
  } catch (err) {
    console.error('‚ùå Ëñ¨Âäπ„É¢„Éº„ÉâË®≠ÂÆöÂÄ§Êõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº:', err);
    res.status(500).json({ error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº' });
  }
});

// „Çµ„Éº„Éê„Éº„ÅÆËµ∑Âãï
app.listen(port, () => {
  console.log(`„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü: http://localhost:${port}`);
}); 